# 四阶龙格—库塔(Runge—Kutta)方法

## 问题分析

### 实验要求

编写代码实现四阶龙格—库塔(Runge—Kutta)方法（下称 RK 法）的算法，用计算机计算的一阶常微分方程初值问题的数值逼近。

### 算法背景

微分方程初值问题的数值解法，即通过某种离散化方法，将微分方程转化为差分方程来求解。RK 法为其中的一种方法。

RK 法间接使用了 Taylor 函数，使用若干点上的函数值的线性组合来代替 F 的导数， 较 n 阶 Euler 法避免了计算 $f(x,y)$ 的导数值。本次实验取阶数为 4，即 4 阶 RK 法。

### 待求解问题

求常微分方程初值问题

$$
\left\{
  \begin{aligned}
    \frac{dy}{dx} &= f(x,y), & a \leqslant x \leqslant b \\
    y(a) &= \alpha, & h = \frac{b-a}{N}
  \end{aligned}
\right.
$$

的数值解 $y_n$ ，$n=1,2,\cdots,N$。

## 数学原理

记 $x_n = a + n\cdot h$, $n = 0,1,\cdots,N$，利用 4 阶 RK法：
$$
\begin{aligned}
K_1 &= hf(x_n,y_n) \\
K_2 &= hf(x_n + \frac{h}{2} + y_n + \frac{K_1}{2}) \\
K_3 &= hf(x_n + \frac{h}{2}, y_n+\frac{K_2}{2}) \\
K_4 &= hf(x_n + h, y_n + K_3) \\
y_{n+1} &= y_n + \frac{1}{6}(K_1+2K_2+2K_3+K_4) \\
&& n = 0,1,\cdots,{N-1}
\end{aligned}
$$
即可逐次求出微分方程初值问题的数值解 $x_n,y_n,n=0,1,2,\cdots,N$。

## 程序设计流程

```python
def Runge_Kutta(
    f:bfunc,
    a:float,
    b:float,
    alpha:float,
    N:int
) -> ndarray:
    """
    Arguments:
        f {bfunc} -- f(x,y)
        a {float} -- 区间左端点
        b {float} -- 区间右端点
        alpha {float} -- 初值
        N {int} -- 等距区间数
    Raises:
        ValueError: 若左端点值大于右端点，抛出 ValueError
    Returns:
        ndarray -- 返回的数值解点集，like [[x_0,y_0],...]
    """
    if a>=b:
        raise ValueError
    x_vector = np.linspace(a,b,N+1)
    ylist = [alpha]
    y = alpha
    h = (b-a)/N
    hf = lambda x,y: h*f(x,y)
    for x in [x for x in x_vector if x !=b]:
        K1=hf(x,y)
        K2=hf(x+h/2,y+K1/2)
        K3=hf(x+h/2,y+K2/2)
        K4=hf(x+h,y+K3)
        y = y+1.0/6*(K1+2*K2+2*K3+K4)
        ylist.append(y)
    y_vector = np.array(ylist).reshape(N+1,-1)
    return np.hstack([x_vector.reshape(N+1,-1),y_vector])
```

## 实验结果、结论与讨论

其中 $S$ 为标准差

### 问题 1

#### (1)
$$
\frac{\mathrm{d}y}{\mathrm{d}x}=x+y,~~x\in[0,1],~~N=5,10,20,~~y(0)=-1
$$
精确解: $y=-x-1$

$N$ =  5,$S$ = 1.570092e-16
| x        | y         |
|----------|-----------|
| 0.000000 | -1.000000 |
| 0.200000 | -1.200000 |
| 0.400000 | -1.400000 |
| 0.600000 | -1.600000 |
| 0.800000 | -1.800000 |
| 1.000000 | -2.000000 |

$N$ = 10,$S$ = 5.142448e-16
| x        | y         |
|----------|-----------|
| 0.000000 | -1.000000 |
| 0.100000 | -1.100000 |
| 0.200000 | -1.200000 |
| 0.300000 | -1.300000 |
| 0.400000 | -1.400000 |
| 0.500000 | -1.500000 |
| 0.600000 | -1.600000 |
| 0.700000 | -1.700000 |
| 0.800000 | -1.800000 |
| 0.900000 | -1.900000 |
| 1.000000 | -2.000000 |

$N$ = 20,$S$ = 4.988655e-16
| x        | y         |
|----------|-----------|
| 0.000000 | -1.000000 |
| 0.050000 | -1.050000 |
| 0.100000 | -1.100000 |
| 0.150000 | -1.150000 |
| 0.200000 | -1.200000 |
| 0.250000 | -1.250000 |
| 0.300000 | -1.300000 |
| 0.350000 | -1.350000 |
| 0.400000 | -1.400000 |
| 0.450000 | -1.450000 |
| 0.500000 | -1.500000 |
| 0.550000 | -1.550000 |
| 0.600000 | -1.600000 |
| 0.650000 | -1.650000 |
| 0.700000 | -1.700000 |
| 0.750000 | -1.750000 |
| 0.800000 | -1.800000 |
| 0.850000 | -1.850000 |
| 0.900000 | -1.900000 |
| 0.950000 | -1.950000 |
| 1.000000 | -2.000000 |


#### (2)
$$
\frac{\mathrm{d}y}{\mathrm{d}x}=-y^2,~~x\in[0,1],~~N=5,10,20,~~y(0)=1
$$
精确解: $y=\frac{1}{x+1}$

$N$ =  5,$S$ = 5.069083e-06
| x        | y        |
|----------|----------|
| 0.000000 | 1.000000 |
| 0.200000 | 0.833339 |
| 0.400000 | 0.714292 |
| 0.600000 | 0.625006 |
| 0.800000 | 0.555561 |
| 1.000000 | 0.500004 |

$N$ = 10,$S$ = 3.581699e-07
| x        | y        |
|----------|----------|
| 0.000000 | 1.000000 |
| 0.100000 | 0.909091 |
| 0.200000 | 0.833334 |
| 0.300000 | 0.769231 |
| 0.400000 | 0.714286 |
| 0.500000 | 0.666667 |
| 0.600000 | 0.625000 |
| 0.700000 | 0.588236 |
| 0.800000 | 0.555556 |
| 0.900000 | 0.526316 |
| 1.000000 | 0.500000 |

$N$ = 20,$S$ = 2.316655e-08
| x        | y        |
|----------|----------|
| 0.000000 | 1.000000 |
| 0.050000 | 0.952381 |
| 0.100000 | 0.909091 |
| 0.150000 | 0.869565 |
| 0.200000 | 0.833333 |
| 0.250000 | 0.800000 |
| 0.300000 | 0.769231 |
| 0.350000 | 0.740741 |
| 0.400000 | 0.714286 |
| 0.450000 | 0.689655 |
| 0.500000 | 0.666667 |
| 0.550000 | 0.645161 |
| 0.600000 | 0.625000 |
| 0.650000 | 0.606061 |
| 0.700000 | 0.588235 |
| 0.750000 | 0.571429 |
| 0.800000 | 0.555556 |
| 0.850000 | 0.540541 |
| 0.900000 | 0.526316 |
| 0.950000 | 0.512821 |
| 1.000000 | 0.500000 |

### 问题 2

#### (1)

$$
\frac{\mathrm{d}y}{\mathrm{d}x}=\frac{2y}{x}+x^2e^x,~~x\in[1,3],~~N=5,10,20,~~y(1)=0
$$
精确解: $y=x^2(e^x-e)$

$N$ =  5,$S$ = 4.227449e-02
| x        | y          |
|----------|------------|
| 1.000000 | 0.000000   |
| 1.400000 | 2.613943   |
| 1.800000 | 10.776313  |
| 2.200000 | 30.491654  |
| 2.600000 | 72.585599  |
| 3.000000 | 156.225198 |

$N$ = 10,$S$ = 3.559349e-03
| x        | y          |
|----------|------------|
| 1.000000 | 0.000000   |
| 1.200000 | 0.866379   |
| 1.400000 | 2.619741   |
| 1.600000 | 5.719895   |
| 1.800000 | 10.792018  |
| 2.000000 | 18.680852  |
| 2.200000 | 30.521598  |
| 2.400000 | 47.832366  |
| 2.600000 | 72.634504  |
| 2.800000 | 107.608852 |
| 3.000000 | 156.298257 |

$N$ = 20,$S$ = 2.593603e-04
| x        | y          |
|----------|------------|
| 1.000000 | 0.000000   |
| 1.100000 | 0.345910   |
| 1.200000 | 0.866622   |
| 1.300000 | 1.607181   |
| 1.400000 | 2.620311   |
| 1.500000 | 3.967602   |
| 1.600000 | 5.720879   |
| 1.700000 | 7.963772   |
| 1.800000 | 10.793502  |
| 1.900000 | 14.322936  |
| 2.000000 | 18.682927  |
| 2.100000 | 24.024989  |
| 2.200000 | 30.524356  |
| 2.300000 | 38.383459  |
| 2.400000 | 47.835905  |
| 2.500000 | 59.151004  |
| 2.600000 | 72.638926  |
| 2.700000 | 88.656573  |
| 2.800000 | 107.614264 |
| 2.900000 | 129.983333 |
| 3.000000 | 156.304772 |


#### (2)

$$
\frac{\mathrm{d}y}{\mathrm{d}x}=\frac{1}{x}(y^2+y),~~x\in[1,3],~~N=5,10,20,~~y(1)=-2
$$
精确解: $y=\frac{2x}{1-2x}$

$N$ =  5,$S$ = 8.636723e-04
| x        | y         |
|----------|-----------|
| 1.000000 | -2.000000 |
| 1.400000 | -1.553989 |
| 1.800000 | -1.383617 |
| 2.200000 | -1.293402 |
| 2.600000 | -1.237540 |
| 3.000000 | -1.199548 |


$N$ = 10,$S$ = 2.098017e-05

| x        | y         |
|----------|-----------|
| 1.000000 | -2.000000 |
| 1.200000 | -1.714245 |
| 1.400000 | -1.555523 |
| 1.600000 | -1.454520 |
| 1.800000 | -1.384595 |
| 2.000000 | -1.333316 |
| 2.200000 | -1.294103 |
| 2.400000 | -1.263145 |
| 2.600000 | -1.238084 |
| 2.800000 | -1.217381 |
| 3.000000 | -1.199991 |

$N$ = 20,$S$ = 2.991036e-07
| x        | y         |
|----------|-----------|
| 1.000000 | -2.000000 |
| 1.100000 | -1.833333 |
| 1.200000 | -1.714285 |
| 1.300000 | -1.625000 |
| 1.400000 | -1.555555 |
| 1.500000 | -1.500000 |
| 1.600000 | -1.454545 |
| 1.700000 | -1.416666 |
| 1.800000 | -1.384615 |
| 1.900000 | -1.357143 |
| 2.000000 | -1.333333 |
| 2.100000 | -1.312500 |
| 2.200000 | -1.294117 |
| 2.300000 | -1.277778 |
| 2.400000 | -1.263158 |
| 2.500000 | -1.250000 |
| 2.600000 | -1.238095 |
| 2.700000 | -1.227273 |
| 2.800000 | -1.217391 |
| 2.900000 | -1.208333 |
| 3.000000 | -1.200000 |


### 问题 3

#### (1)

$$
\frac{\mathrm{d}y}{\mathrm{d}x}=-20(y-x^2)+2x,~~x\in[0,1],~~N=5,10,20,~~y(0)=\frac{1}{3}
$$
精确解: $y=x^2+\frac{1}{3}e^{-20x}$

$N$ =  5,$S$ = 4.513822e+02
| x        | y           |
|----------|-------------|
| 0.000000 | 0.333333    |
| 0.200000 | 1.760000    |
| 0.400000 | 8.813333    |
| 0.600000 | 43.680000   |
| 0.800000 | 217.293333  |
| 1.000000 | 1084.320000 |

$N$ = 10,$S$ = 2.328359e-02
| x        | y        |
|----------|----------|
| 0.000000 | 0.333333 |
| 0.100000 | 0.122778 |
| 0.200000 | 0.079259 |
| 0.300000 | 0.104753 |
| 0.400000 | 0.166584 |
| 0.500000 | 0.253861 |
| 0.600000 | 0.362954 |
| 0.700000 | 0.492651 |
| 0.800000 | 0.642550 |
| 0.900000 | 0.812517 |
| 1.000000 | 1.002506 |

$N$ = 20,$S$ = 7.217970e-04
| x        | y        |
|----------|----------|
| 0.000000 | 0.333333 |
| 0.050000 | 0.127552 |
| 0.100000 | 0.056947 |
| 0.150000 | 0.040157 |
| 0.200000 | 0.046673 |
| 0.250000 | 0.065055 |
| 0.300000 | 0.091010 |
| 0.350000 | 0.122931 |
| 0.400000 | 0.160214 |
| 0.450000 | 0.202632 |
| 0.500000 | 0.250102 |
| 0.550000 | 0.302590 |
| 0.600000 | 0.360086 |
| 0.650000 | 0.422584 |
| 0.700000 | 0.490084 |
| 0.750000 | 0.562583 |
| 0.800000 | 0.640083 |
| 0.850000 | 0.722583 |
| 0.900000 | 0.810083 |
| 0.950000 | 0.902583 |
| 1.000000 | 1.000083 |


#### (2)

$$
\frac{\mathrm{d}y}{\mathrm{d}x}=-20y+20\sin x +\cos x,~~x\in[0,1],~~N=5,10,20,~~y(0)=1
$$
精确解: $y=e^{-20x}+\sin x$

$N$ =  5,$S$ = 1.301231e+03
| x        | y           |
|----------|-------------|
| 0.000000 | 1.000000    |
| 0.200000 | 5.197338    |
| 0.400000 | 25.376171   |
| 0.600000 | 125.486815  |
| 0.800000 | 625.312096  |
| 1.000000 | 3123.795151 |

$N$ = 10,$S$ = 6.681782e-02
| x        | y        |
|----------|----------|
| 0.000000 | 1.000000 |
| 0.100000 | 0.433139 |
| 0.200000 | 0.309660 |
| 0.300000 | 0.332325 |
| 0.400000 | 0.401414 |
| 0.500000 | 0.483074 |
| 0.600000 | 0.565435 |
| 0.700000 | 0.643989 |
| 0.800000 | 0.716722 |
| 0.900000 | 0.782499 |
| 1.000000 | 0.840526 |

$N$ = 20,$S$ = 2.070013e-03


#### (3)

$$
\frac{\mathrm{d}y}{\mathrm{d}x}=-20(y-e^x\sin x)+e^x(\sin x + \cos x),~~x\in[0,1],~~N=5,10,20,~~y(0)=0
$$
精确解: $y=e^x\sin x$

$N$ =  5,$S$ = 1.902084e+01
| x        | y        |
|----------|----------|
| 0.000000 | 1.000000 |
| 0.050000 | 0.424979 |
| 0.100000 | 0.240456 |
| 0.150000 | 0.202168 |
| 0.200000 | 0.218439 |
| 0.250000 | 0.254812 |
| 0.300000 | 0.298291 |
| 0.350000 | 0.343929 |
| 0.400000 | 0.389795 |
| 0.450000 | 0.435096 |
| 0.500000 | 0.479463 |
| 0.550000 | 0.522688 |
| 0.600000 | 0.564629 |
| 0.650000 | 0.605166 |
| 0.700000 | 0.644194 |
| 0.750000 | 0.681613 |
| 0.800000 | 0.717328 |
| 0.850000 | 0.751251 |
| 0.900000 | 0.783296 |
| 0.950000 | 0.813383 |
| 1.000000 | 0.841437 |


$N$ = 10,$S$ = 3.148600e-03
| x        | y        |
|----------|----------|
| 0.000000 | 0.000000 |
| 0.100000 | 0.112055 |
| 0.200000 | 0.245117 |
| 0.300000 | 0.401778 |
| 0.400000 | 0.584097 |
| 0.500000 | 0.793822 |
| 0.600000 | 1.032418 |
| 0.700000 | 1.301015 |
| 0.800000 | 1.600321 |
| 0.900000 | 1.930521 |
| 1.000000 | 2.291157 |


$N$ = 20,$S$ = 1.101164e-04
| x        | y        |
|----------|----------|
| 0.000000 | 0.000000 |
| 0.050000 | 0.052595 |
| 0.100000 | 0.110409 |
| 0.150000 | 0.173709 |
| 0.200000 | 0.242749 |
| 0.250000 | 0.317772 |
| 0.300000 | 0.399014 |
| 0.350000 | 0.486702 |
| 0.400000 | 0.581054 |
| 0.450000 | 0.682276 |
| 0.500000 | 0.790556 |
| 0.550000 | 0.906069 |
| 0.600000 | 1.028968 |
| 0.650000 | 1.159384 |
| 0.700000 | 1.297422 |
| 0.750000 | 1.443157 |
| 0.800000 | 1.596634 |
| 0.850000 | 1.757860 |
| 0.900000 | 1.926802 |
| 0.950000 | 2.103383 |
| 1.000000 | 2.287480 |


### 思考题

**（1）** 对实验 1，数值解和解析解相同吗？为什么？试加以说明。

相同。首先从结果上看，数值解与精确解的标准差级别为 $10^{-16}$ ，与值相比如此小的误差几乎可以忽略不计。从理论上看，由于本体的精确解为线性函数，所以数值解法构造的差分函数每次计算求得的都是精确值。本例中产生的误差应为计算中产生的舍入误差。

**（2）** 对实验 2，$N$ 越大越精确吗？试加以说明。

 对实验 2，$N$ 越大越精确。这点可从比较 $N$ 取不同值时数值解与真值的标准差得到。有 $N$ 越大标准差越大。

其中的原因即数值积分的本质：构造差分函数，用差分近似替代微分。当差分继续细分时就趋近于微分。

实际上 4 阶 RK 法对于常微分方程
$$
\left\{
  \begin{aligned}
    \frac{dy}{dx} &= f(x,y), & a \leqslant x \leqslant b \\
    y(a) &= \alpha, & h = \frac{b-a}{N}
  \end{aligned}
\right.
$$

是稳定的，且是收敛的。从而不难得出 $N$ 越大越精确这样的结论。

**（3）** 对实验 3，$N$ 较小会出现什么现象？试加以说明。

当 $N$ 较小时数值解与正确结果相差较大。可以看到当 $N=5$ 时实验三的三例的标准差数量级分别为 $10^2,10^3,10^1$ ，这样的误差相当大。但我们也可以看到当 $N=10$ 时误差就降到较能接受的范围了。

由（2）中所讨论的那样，4 阶 RK 法对于此类问题是稳定且收敛的，于是当 $N$ 足够大时误差总能降到所需精度之下，但在实际问题的求解中，我们往往是不知道微分方程的精确解的，故 RK 法 $N$ 的选取存在困难。若逐渐增加 $N$ 值直到满足精度要求又会造成计算资源的浪费。故可以采取如下策略：恰当选取 $N$ 的初值与步长，比较这一次与上一次的数值解，知道满足精度要求。
